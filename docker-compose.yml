version: '3.8'

services:
  redpanda-parquet-collector:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: redpanda-parquet-collector
    restart: "no"  # Container exits after single run
    
    # Mount the output directory and logs directory to the host
    volumes:
      - /data/datalake/redpanda_backup:/app/output
      - /logs:/app/logs
    
    # Environment variables
    environment:
      # Redpanda connection (update this to match your Redpanda instance)
      - BOOTSTRAP_SERVERS=192.168.1.110:19092
      
      # Output directory (mapped to /data/datalake/redpanda_backup on host)
      - OUTPUT_DIR=/app/output
      
      # Log directory (mapped to /logs on host)
      - LOG_DIR=/app/logs
      
      # Processing configuration
      - MAX_MESSAGES=
      - BATCH_SIZE=1000000      # 1M messages per batch (optimized for one-time exports)
      - MAX_WORKERS=4
      - SKIP_EXISTING_CHECK=true
      - SKIP_DEDUPLICATION=true # Skip deduplication for massive speedup on one-time exports
      - SKIP_VALIDATION=false  # Set to true to skip post-run validation
      
      # Advanced Performance Configuration
      - PARQUET_COMPRESSION=zstd      # snappy, zstd, gzip
      - COMPRESSION_LEVEL=3            # 1-22 for zstd
      - ROW_GROUP_SIZE=1000000         # Rows per parquet row group
      - FETCH_MIN_BYTES=10485760       # 10MB
      - MAX_PARTITION_FETCH_BYTES=52428800  # 50MB
      - PROGRESS_UPDATE_INTERVAL=250000  # Update progress every 250K msgs
      - MEMORY_BATCH_SIZE=1000000       # Convert to DF every 1M messages
      
      # Terminal/Rich library settings (for proper progress bar rendering)
      - TERM=xterm-256color
      - PYTHONUNBUFFERED=1
    
    # Network configuration
    network_mode: "host"
    
    # Remove the healthcheck since the app doesn't expose an HTTP endpoint
    healthcheck:
      disable: true
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Parquet Reader Service - Analyze parquet files created by the collector
  parquet-reader:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: parquet-reader
    restart: "no"
    
    # Mount the output directory to read parquet files
    volumes:
      - /data/datalake/redpanda_backup:/app/output
    
    # Environment variables
    environment:
      - OUTPUT_DIR=/app/output
      - TERM=xterm-256color
      - PYTHONUNBUFFERED=1
    
    # Network configuration
    network_mode: "host"
    
    # Override the default CMD to run the reader instead
    command: python parquet_to_polars.py
    
    # Optional: only start when explicitly requested
    profiles:
      - tools
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: If you want to run Redpanda locally in Docker as well
# Uncomment the following sections:

#  redpanda:
#    image: docker.redpanda.com/redpandadata/redpanda:latest
#    container_name: redpanda
#    command:
#      - redpanda
#      - start
#      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
#      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
#      - --pandaproxy-addr internal://0.0.0.0:8082,external://0.0.0.0:18082
#      - --advertise-pandaproxy-addr internal://redpanda:8082,external://localhost:18082
#      - --schema-registry-addr internal://0.0.0.0:8081,external://0.0.0.0:18081
#      - --rpc-addr redpanda:33145
#      - --advertise-rpc-addr redpanda:33145
#      - --mode dev-container
#      - --smp 1
#      - --default-log-level=info
#    ports:
#      - 18081:18081
#      - 18082:18082
#      - 19092:19092
#      - 19644:9644
#    volumes:
#      - redpanda-data:/var/lib/redpanda/data
#    healthcheck:
#      test: ["CMD-SHELL", "rpk cluster health | grep -E 'Healthy:.+true' || exit 1"]
#      interval: 15s
#      timeout: 3s
#      retries: 5
#      start_period: 5s
#
#volumes:
#  redpanda-data:

